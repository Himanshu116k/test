
name: main

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

concurrency:
 group: main-deploy
 cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure backend folder permissions
        uses: appleboy/ssh-action@v1.0.3
        with:
            host: ${{ secrets.EC2_HOST }}
            username: ${{ secrets.EC2_USER }}
            key: ${{ secrets.EC2_SSH_KEY }}
            script: |
                mkdir -p /home/${{ secrets.EC2_USER }}/backend
                sudo chown -R $USER:$USER /home/${{ secrets.EC2_USER }}/backend
                sudo chmod -R u+rwX /home/${{ secrets.EC2_USER }}/backend

      - name: Upload project to EC2 (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
              host: ${{ secrets.EC2_HOST }}
              username: ${{ secrets.EC2_USER }}
              key: ${{ secrets.EC2_SSH_KEY }}
              source: .
              target: /home/${{ secrets.EC2_USER }}/backend
              overwrite: true

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
              APP_DIR: /home/${{ secrets.EC2_USER }}/backend
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
              cd /home/${{ secrets.EC2_USER }}/backend

              npm install
              
              
              fuser -k 8000/tcp || true
              if ! command -v pm2 &> /dev/null
              then
                sudo npm install -g pm2
              fi
             
              pm2 delete backend || true
              pm2 start index.js --name backend --time
              echo "Deployment complete and server restarted!"

  